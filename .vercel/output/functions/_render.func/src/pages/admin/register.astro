---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Check if already logged in
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);
if (token) {
  const user = await validateSession(token);
  if (user) {
    return Astro.redirect('/admin');
  }
}

// Check if any users exist (only allow registration if no users exist)
const userCount = await prisma.user.count();
const allowRegistration = userCount === 0;
---

<Layout title="Créer un compte Admin">
  <div class="admin-login">
    <div class="admin-login__card">
      <h1>Créer un compte</h1>

      {allowRegistration ? (
        <>
          <p class="admin-login__subtitle">Premier compte administrateur</p>

          <form id="register-form" class="form">
            <div id="error-message" class="form__error" style="display: none;"></div>

            <div class="form__group">
              <label for="name" class="form__label">Nom</label>
              <input
                type="text"
                id="name"
                name="name"
                class="form__input"
                autocomplete="name"
              />
            </div>

            <div class="form__group">
              <label for="email" class="form__label form__label--required">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                class="form__input"
                required
                autocomplete="email"
              />
            </div>

            <div class="form__group">
              <label for="password" class="form__label form__label--required">Mot de passe</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form__input"
                required
                minlength="8"
                autocomplete="new-password"
              />
              <span class="form__hint">Minimum 8 caractères</span>
            </div>

            <button type="submit" class="btn btn--primary btn--lg btn--full" id="submit-btn">
              Créer le compte
            </button>
          </form>
        </>
      ) : (
        <>
          <p class="admin-login__subtitle">L'inscription est désactivée.</p>
          <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">
            Un compte administrateur existe déjà. Contactez l'administrateur pour obtenir un accès.
          </p>
          <a href="/admin/login" class="btn btn--outline btn--lg btn--full" style="margin-top: var(--space-6);">
            Se connecter
          </a>
        </>
      )}
    </div>
  </div>
</Layout>

<style>
  .admin-login {
    min-height: calc(100vh - 200px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
  }

  .admin-login__card {
    width: 100%;
    max-width: 400px;
    padding: var(--space-8);
    background: var(--color-surface);
    border: var(--border-width) solid var(--color-border-light);
  }

  .admin-login__card h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-2);
  }

  .admin-login__subtitle {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .form__error {
    padding: var(--space-3) var(--space-4);
    background-color: #fef2f2;
    border: 1px solid var(--color-error);
    color: var(--color-error);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-4);
  }
</style>

<script>
  const form = document.getElementById('register-form') as HTMLFormElement | null;

  if (form) {
    const errorDiv = document.getElementById('error-message') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Création...';

      const formData = new FormData(form);

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la création');
        }

        // Redirect to admin dashboard
        window.location.href = '/admin';
      } catch (error) {
        errorDiv.textContent = error instanceof Error ? error.message : 'Erreur lors de la création';
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Créer le compte';
      }
    });
  }
</script>
