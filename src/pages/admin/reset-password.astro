---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validatePasswordResetToken, validateSession, parseSessionCookie } from '../../lib/auth';

// Check if already logged in
const cookieHeader = Astro.request.headers.get('cookie');
const sessionToken = parseSessionCookie(cookieHeader);
if (sessionToken) {
  const user = await validateSession(sessionToken);
  if (user) {
    return Astro.redirect('/admin');
  }
}

// Get and validate token from URL
const token = Astro.url.searchParams.get('token');
let isValidToken = false;

if (token) {
  const userId = await validatePasswordResetToken(token);
  isValidToken = userId !== null;
}
---

<Layout title="Réinitialiser le mot de passe">
  <div class="admin-login">
    <div class="admin-login__card">
      {!token || !isValidToken ? (
        <>
          <h1>Lien invalide</h1>
          <p class="admin-login__subtitle">
            Ce lien de réinitialisation est invalide ou a expiré. Veuillez faire une nouvelle demande.
          </p>
          <a href="/admin/forgot-password" class="btn btn--primary btn--lg btn--full">
            Nouvelle demande
          </a>
        </>
      ) : (
        <>
          <h1>Nouveau mot de passe</h1>
          <p class="admin-login__subtitle">Entrez votre nouveau mot de passe</p>

          <form id="reset-form" class="form">
            <input type="hidden" name="token" value={token} />
            <div id="message" class="form__message" style="display: none;"></div>

            <div class="form__group">
              <label for="password" class="form__label form__label--required">Nouveau mot de passe</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form__input"
                required
                minlength="8"
                autocomplete="new-password"
              />
              <small class="form__hint">Minimum 8 caractères</small>
            </div>

            <div class="form__group">
              <label for="confirmPassword" class="form__label form__label--required">Confirmer le mot de passe</label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                class="form__input"
                required
                minlength="8"
                autocomplete="new-password"
              />
            </div>

            <button type="submit" class="btn btn--primary btn--lg btn--full" id="submit-btn">
              Réinitialiser le mot de passe
            </button>
          </form>
        </>
      )}

      <p class="admin-login__register">
        <a href="/admin/login">Retour à la connexion</a>
      </p>
    </div>
  </div>
</Layout>

<style>
  .admin-login {
    min-height: calc(100vh - 200px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
  }

  .admin-login__card {
    width: 100%;
    max-width: 400px;
    padding: var(--space-8);
    background: var(--color-surface);
    border: var(--border-width) solid var(--color-border-light);
  }

  .admin-login__card h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-2);
  }

  .admin-login__subtitle {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .admin-login__register {
    margin-top: var(--space-6);
    text-align: center;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .form__message {
    padding: var(--space-3) var(--space-4);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-4);
  }

  .form__message.error {
    background-color: #fef2f2;
    border: 1px solid var(--color-error);
    color: var(--color-error);
  }

  .form__message.success {
    background-color: #f0fdf4;
    border: 1px solid #16a34a;
    color: #16a34a;
  }

  .form__hint {
    display: block;
    margin-top: var(--space-1);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }
</style>

<script>
  const form = document.getElementById('reset-form') as HTMLFormElement | null;
  if (form) {
    const messageDiv = document.getElementById('message') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.style.display = 'none';

      const password = (form.querySelector('#password') as HTMLInputElement).value;
      const confirmPassword = (form.querySelector('#confirmPassword') as HTMLInputElement).value;

      if (password !== confirmPassword) {
        messageDiv.textContent = 'Les mots de passe ne correspondent pas';
        messageDiv.className = 'form__message error';
        messageDiv.style.display = 'block';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Réinitialisation...';

      const formData = new FormData(form);

      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la réinitialisation');
        }

        messageDiv.textContent = data.message + ' Redirection...';
        messageDiv.className = 'form__message success';
        messageDiv.style.display = 'block';

        // Redirect to login after 2 seconds
        setTimeout(() => {
          window.location.href = '/admin/login';
        }, 2000);
      } catch (error) {
        messageDiv.textContent = error instanceof Error ? error.message : 'Erreur lors de la réinitialisation';
        messageDiv.className = 'form__message error';
        messageDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Réinitialiser le mot de passe';
      }
    });
  }
</script>
