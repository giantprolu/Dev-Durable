---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Get services from database
const services = await prisma.service.findMany({
  orderBy: { order: 'asc' },
});
---

<Layout title="Gestion des services">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" />

  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Services</h1>
        <p>{services.length} service{services.length > 1 ? 's' : ''}</p>
      </div>
      <div class="admin-page__actions">
        <a href="/admin" class="btn btn--back">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Retour
        </a>
        <button type="button" class="btn btn--primary" id="new-service-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nouveau service
        </button>
      </div>
    </header>

    <div id="form-message" class="form-message" style="display: none;"></div>

    <!-- Services List -->
    <div class="services-list" id="services-list">
      {services.map((service, index) => (
        <article class="service-item-admin" data-id={service.id}>
          <div class="service-item-admin__header">
            <span class="service-item-admin__order">{String(index + 1).padStart(2, '0')}</span>
            <div class="service-item-admin__info">
              <h3>{service.title}</h3>
              <span class="service-item-admin__slug">/services/{service.slug}</span>
            </div>
            <div class="service-item-admin__status">
              {service.published ? (
                <span class="badge badge--success">Publié</span>
              ) : (
                <span class="badge badge--warning">Brouillon</span>
              )}
            </div>
            <div class="service-item-admin__actions">
              <button type="button" class="btn btn--sm btn--edit edit-service-btn" data-id={service.id}>
                Modifier
              </button>
              <button type="button" class="btn btn--sm btn--danger delete-service-btn" data-id={service.id} data-title={service.title}>
                Supprimer
              </button>
            </div>
          </div>
        </article>
      ))}
    </div>

    {services.length === 0 && (
      <div class="empty-state">
        <p>Aucun service. Créez votre premier service.</p>
      </div>
    )}
  </div>

  <!-- Modal for editing/creating service -->
  <div class="modal" id="service-modal" hidden>
    <div class="modal__backdrop"></div>
    <div class="modal__content">
      <header class="modal__header">
        <h2 id="modal-title">Nouveau service</h2>
        <button type="button" class="modal__close" id="close-modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </header>

      <form id="service-form" class="modal__body">
        <input type="hidden" id="service-id" name="id" value="" />

        <!-- Tabs -->
        <div class="form-tabs">
          <button type="button" class="form-tab active" data-tab="general">Général</button>
          <button type="button" class="form-tab" data-tab="content">Contenu</button>
          <button type="button" class="form-tab" data-tab="sidebar">Sidebar</button>
          <button type="button" class="form-tab" data-tab="formats">Formats</button>
        </div>

        <!-- Tab: General -->
        <div class="form-tab-content active" data-tab="general">
          <div class="form-grid">
            <div class="form-field">
              <label for="service-title">
                <span class="form-field__label">Titre du service</span>
                <span class="form-field__required">*</span>
              </label>
              <input type="text" id="service-title" name="title" required placeholder="Ex: Stratégie RSE" />
            </div>

            <div class="form-field">
              <label for="service-slug">
                <span class="form-field__label">URL (slug)</span>
                <span class="form-field__required">*</span>
              </label>
              <div class="form-field__input-group">
                <span class="form-field__prefix">/services/</span>
                <input type="text" id="service-slug" name="slug" required placeholder="strategie-rse" />
              </div>
              <span class="form-field__hint">L'URL sera: /services/votre-slug</span>
            </div>

            <div class="form-field form-field--full">
              <label for="service-summary">
                <span class="form-field__label">Résumé</span>
                <span class="form-field__required">*</span>
              </label>
              <textarea id="service-summary" name="summary" rows="3" required placeholder="Description courte affichée sur la page d'accueil..."></textarea>
            </div>

            <div class="form-field">
              <label for="service-page-title">
                <span class="form-field__label">Titre de la page</span>
              </label>
              <input type="text" id="service-page-title" name="pageTitle" placeholder="Laissez vide pour utiliser le titre" />
            </div>

            <div class="form-field">
              <label for="service-published">
                <span class="form-field__label">Statut</span>
              </label>
              <select id="service-published" name="published">
                <option value="true">Publié</option>
                <option value="false">Brouillon</option>
              </select>
            </div>

            <div class="form-field form-field--full">
              <label for="service-page-description">
                <span class="form-field__label">Description de la page</span>
              </label>
              <textarea id="service-page-description" name="pageDescription" rows="2" placeholder="Description SEO (laissez vide pour utiliser le résumé)"></textarea>
            </div>
          </div>
        </div>

        <!-- Tab: Content -->
        <div class="form-tab-content" data-tab="content">
          <div class="form-field">
            <label>
              <span class="form-field__label">Contenu principal</span>
            </label>
            <div id="description-editor" class="quill-editor"></div>
            <input type="hidden" id="service-description" name="description" />
          </div>

          <div class="form-grid" style="margin-top: var(--space-6);">
            <div class="form-field">
              <label for="service-cta-title">
                <span class="form-field__label">Titre CTA (bas de page)</span>
              </label>
              <input type="text" id="service-cta-title" name="ctaTitle" placeholder="Intéressé par ce service ?" />
            </div>

            <div class="form-field">
              <label for="service-cta-text">
                <span class="form-field__label">Texte CTA</span>
              </label>
              <input type="text" id="service-cta-text" name="ctaText" placeholder="Discutons de votre projet." />
            </div>
          </div>
        </div>

        <!-- Tab: Sidebar -->
        <div class="form-tab-content" data-tab="sidebar">
          <div class="form-field">
            <label for="service-sidebar-title">
              <span class="form-field__label">Titre de la sidebar</span>
            </label>
            <input type="text" id="service-sidebar-title" name="sidebarTitle" placeholder="Livrables" />
          </div>

          <div class="form-field">
            <label>
              <span class="form-field__label">Éléments de la sidebar</span>
            </label>
            <div id="sidebar-items-list" class="dynamic-list"></div>
            <button type="button" class="btn btn--sm btn--secondary" id="add-sidebar-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter un élément
            </button>
          </div>
        </div>

        <!-- Tab: Formats -->
        <div class="form-tab-content" data-tab="formats">
          <div class="formats-intro">
            <p class="form-hint">Ajoutez des formats d'intervention pour présenter vos différentes offres.</p>
          </div>
          <div id="formats-list" class="formats-editor"></div>
          <button type="button" class="btn btn--sm btn--success" id="add-format">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Ajouter un format
          </button>
        </div>
      </form>

      <footer class="modal__footer">
        <button type="button" class="btn btn--secondary" id="cancel-btn">Annuler</button>
        <button type="button" class="btn btn--primary" id="save-service-btn">Enregistrer</button>
      </footer>
    </div>
  </div>

  <!-- Media Picker Modal -->
  <div class="modal media-picker-modal" id="media-picker-modal" hidden>
    <div class="modal__backdrop media-backdrop"></div>
    <div class="modal__content media-picker-content">
      <header class="modal__header">
        <h2>Bibliothèque de médias</h2>
        <button type="button" class="modal__close" id="close-media-picker">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </header>
      <div class="media-picker-body">
        <div class="media-picker-loading" id="media-loading">Chargement...</div>
        <div class="media-picker-grid" id="media-grid"></div>
        <div class="media-picker-empty" id="media-empty" style="display: none;">
          Aucun média. <a href="/admin/media" target="_blank">Téléchargez des images</a> dans la bibliothèque.
        </div>
      </div>
      <footer class="modal__footer">
        <button type="button" class="btn btn--secondary" id="cancel-media-picker">Annuler</button>
        <button type="button" class="btn btn--primary" id="select-media-btn" disabled>Sélectionner</button>
      </footer>
    </div>
  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-xl);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .admin-page__actions {
    display: flex;
    gap: var(--space-2);
    align-items: center;
    flex-wrap: wrap;
  }

  /* Mobile responsive - Services Admin */
  @media (max-width: 767px) {
    .admin-page {
      padding: var(--space-4) var(--space-3);
    }

    .admin-page__header {
      flex-direction: column;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .admin-page__header h1 {
      font-size: var(--font-size-xl);
    }

    .admin-page__actions {
      width: 100%;
    }

    .admin-page__actions .btn {
      flex: 1;
      justify-content: center;
    }

    .service-item-admin__header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .service-item-admin__order {
      position: absolute;
      top: var(--space-2);
      right: var(--space-2);
      font-size: var(--font-size-base);
    }

    .service-item-admin {
      position: relative;
    }

    .service-item-admin__info {
      min-width: 100%;
    }

    .service-item-admin__status {
      min-width: auto;
    }

    .service-item-admin__actions {
      width: 100%;
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-light);
    }

    .service-item-admin__actions .btn {
      flex: 1;
      justify-content: center;
    }

    /* Modal responsive */
    .modal__content {
      max-width: 100%;
      max-height: 100vh;
      border: none;
    }

    .modal__header {
      padding: var(--space-3) var(--space-4);
    }

    .modal__header h2 {
      font-size: var(--font-size-lg);
    }

    .modal__body {
      padding: var(--space-4);
    }

    .modal__footer {
      padding: var(--space-3) var(--space-4);
      flex-direction: column;
    }

    .modal__footer .btn {
      width: 100%;
      justify-content: center;
    }

    .form-tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      flex-wrap: nowrap;
    }

    .form-tab {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
      white-space: nowrap;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }
  }

  .form-message {
    padding: var(--space-4);
    margin-bottom: var(--space-6);
    font-weight: var(--font-weight-medium);
    border: var(--border-width-thick) solid;
  }

  .form-message.success {
    background: var(--color-primary);
    color: var(--color-ink);
    border-color: var(--color-ink);
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #721c24;
  }

  /* Services List */
  .services-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .service-item-admin {
    background: var(--color-white);
    border: var(--border-width-thick) solid var(--color-ink);
  }

  .service-item-admin__header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    flex-wrap: wrap;
  }

  .service-item-admin__order {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    min-width: 40px;
  }

  .service-item-admin__info {
    flex: 1;
    min-width: 200px;
  }

  .service-item-admin__info h3 {
    font-size: var(--font-size-lg);
    margin: 0 0 var(--space-1) 0;
  }

  .service-item-admin__slug {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-family: monospace;
  }

  .service-item-admin__status {
    min-width: 80px;
  }

  .service-item-admin__actions {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
    text-transform: uppercase;
  }

  .badge--success {
    background: var(--color-primary);
    color: var(--color-ink);
  }

  .badge--warning {
    background: var(--color-sand);
    color: var(--color-ink);
    border: 1px solid var(--color-ink);
  }

  .empty-state {
    padding: var(--space-12);
    text-align: center;
    background: var(--color-cream);
    border: 3px dashed var(--color-border);
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
  }

  .modal[hidden] {
    display: none;
  }

  .modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
  }

  .modal__content {
    position: relative;
    background: var(--color-white);
    border: var(--border-width-thick) solid var(--color-ink);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }

  .modal__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-6);
    background: var(--color-ink);
    color: var(--color-white);
  }

  .modal__header h2 {
    font-size: var(--font-size-xl);
    margin: 0;
    color: var(--color-white);
  }

  .modal__close {
    background: transparent;
    border: none;
    color: var(--color-white);
    cursor: pointer;
    padding: var(--space-1);
  }

  .modal__close:hover {
    color: var(--color-primary);
  }

  .modal__body {
    padding: var(--space-6);
    overflow-y: auto;
    flex: 1;
  }

  .modal__footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-6);
    border-top: var(--border-width) solid var(--color-border);
    background: var(--color-cream);
  }

  /* Form Tabs */
  .form-tabs {
    display: flex;
    gap: var(--space-1);
    margin-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-ink);
    flex-wrap: wrap;
  }

  .form-tab {
    padding: var(--space-3) var(--space-4);
    background: transparent;
    border: none;
    font-weight: var(--font-weight-bold);
    color: var(--color-text-secondary);
    cursor: pointer;
    position: relative;
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    font-size: var(--font-size-sm);
  }

  .form-tab:hover {
    color: var(--color-ink);
  }

  .form-tab.active {
    color: var(--color-ink);
    background: var(--color-primary);
  }

  .form-tab-content {
    display: none;
  }

  .form-tab-content.active {
    display: block;
  }

  /* Form Fields */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  @media (max-width: 600px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-field--full {
    grid-column: 1 / -1;
  }

  .form-field label {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .form-field__label {
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
  }

  .form-field__required {
    color: var(--color-error);
    font-weight: var(--font-weight-bold);
  }

  .form-field input,
  .form-field textarea,
  .form-field select {
    width: 100%;
    padding: var(--space-3);
    border: var(--border-width) solid var(--color-border);
    font-size: var(--font-size-base);
    font-family: inherit;
    background: var(--color-white);
  }

  .form-field input:focus,
  .form-field textarea:focus,
  .form-field select:focus {
    outline: none;
    border-color: var(--color-ink);
  }

  .form-field__hint {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .form-field__input-group {
    display: flex;
    align-items: stretch;
  }

  .form-field__prefix {
    display: flex;
    align-items: center;
    padding: 0 var(--space-3);
    background: var(--color-sand);
    border: var(--border-width) solid var(--color-border);
    border-right: none;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    font-family: monospace;
  }

  .form-field__input-group input {
    flex: 1;
  }

  .form-hint {
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  /* Quill Editor */
  .quill-editor {
    background: var(--color-white);
    border: var(--border-width) solid var(--color-border);
    min-height: 300px;
  }

  :global(.ql-toolbar) {
    border: none !important;
    border-bottom: var(--border-width) solid var(--color-border) !important;
    background: var(--color-cream);
  }

  :global(.ql-container) {
    border: none !important;
    font-size: var(--font-size-base);
    font-family: inherit;
  }

  /* Dynamic List (sidebar items) */
  .dynamic-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }

  .dynamic-list__item {
    display: flex;
    gap: var(--space-2);
    align-items: center;
  }

  .dynamic-list__item input {
    flex: 1;
    padding: var(--space-2);
    border: var(--border-width) solid var(--color-border);
    font-size: var(--font-size-sm);
  }

  .dynamic-list__remove {
    background: transparent;
    border: none;
    color: var(--color-error);
    cursor: pointer;
    padding: var(--space-1);
  }

  /* Formats Editor */
  .formats-intro {
    margin-bottom: var(--space-4);
    padding: var(--space-3);
    background: var(--color-cream);
    border-left: 3px solid var(--color-primary);
  }

  .formats-editor {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  :global(.format-editor-item) {
    padding: var(--space-5);
    background: var(--color-white);
    border: var(--border-width-thick) solid var(--color-ink);
  }

  :global(.format-editor-item__header) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 2px solid var(--color-sand);
  }

  :global(.format-editor-item__header h4) {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    margin: 0;
    color: var(--color-primary);
  }

  :global(.format-editor-item__fields) {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  @media (max-width: 600px) {
    :global(.format-editor-item__fields) {
      grid-template-columns: 1fr;
    }
  }

  :global(.format-editor-item__fields .form-field--full) {
    grid-column: 1 / -1;
  }

  :global(.format-editor-item .form-field) {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  :global(.format-editor-item .form-field label) {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  :global(.format-editor-item .form-field__label) {
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    color: var(--color-text);
  }

  :global(.format-editor-item input),
  :global(.format-editor-item textarea) {
    width: 100%;
    padding: var(--space-3);
    border: var(--border-width) solid var(--color-border);
    font-size: var(--font-size-base);
    font-family: inherit;
    background: var(--color-white);
  }

  :global(.format-editor-item input:focus),
  :global(.format-editor-item textarea:focus) {
    outline: none;
    border-color: var(--color-ink);
  }

  /* Image picker field */
  :global(.image-picker-field) {
    display: flex;
    gap: var(--space-2);
    align-items: flex-start;
  }

  :global(.image-picker-field input) {
    flex: 1;
  }

  :global(.image-picker-field .btn-pick-media) {
    flex-shrink: 0;
    padding: var(--space-2) var(--space-3);
    background: var(--color-ink);
    color: var(--color-white);
    border: none;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    text-transform: uppercase;
    white-space: nowrap;
  }

  :global(.image-picker-field .btn-pick-media:hover) {
    background: var(--color-primary);
    color: var(--color-ink);
  }

  :global(.image-preview) {
    margin-top: var(--space-2);
    max-width: 200px;
    border: var(--border-width) solid var(--color-border);
  }

  :global(.image-preview img) {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Media Picker Modal */
  .media-picker-modal .modal__content {
    max-width: 900px;
    max-height: 80vh;
  }

  .media-picker-body {
    padding: var(--space-4);
    overflow-y: auto;
    max-height: 50vh;
    background: var(--color-cream);
  }

  .media-picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: var(--space-3);
  }

  .media-picker-item {
    position: relative;
    aspect-ratio: 1;
    border: 3px solid transparent;
    cursor: pointer;
    overflow: hidden;
    background: var(--color-white);
  }

  .media-picker-item:hover {
    border-color: var(--color-border);
  }

  .media-picker-item.selected {
    border-color: var(--color-primary);
  }

  .media-picker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .media-picker-loading,
  .media-picker-empty {
    padding: var(--space-8);
    text-align: center;
    color: var(--color-text-muted);
  }

  .media-picker-empty a {
    color: var(--color-ink);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .admin-page__header {
      flex-direction: column;
      align-items: flex-start;
    }

    .service-item-admin__header {
      flex-direction: column;
      align-items: flex-start;
    }

    .modal__content {
      max-height: 100vh;
      height: 100vh;
    }
  }
</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script is:inline>
  var modal = document.getElementById('service-modal');
  var modalTitle = document.getElementById('modal-title');
  var form = document.getElementById('service-form');
  var serviceIdInput = document.getElementById('service-id');
  var messageEl = document.getElementById('form-message');
  var newServiceBtn = document.getElementById('new-service-btn');
  var closeModalBtn = document.getElementById('close-modal');
  var cancelBtn = document.getElementById('cancel-btn');
  var saveBtn = document.getElementById('save-service-btn');
  var servicesList = document.getElementById('services-list');

  // Initialize Quill editor
  var quill = new Quill('#description-editor', {
    theme: 'snow',
    placeholder: 'Rédigez le contenu principal de la page service...',
    modules: {
      toolbar: [
        [{ 'header': [2, 3, 4, false] }],
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link'],
        ['clean']
      ]
    }
  });

  // Tab navigation
  var tabs = document.querySelectorAll('.form-tab');
  var tabContents = document.querySelectorAll('.form-tab-content');

  tabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      var targetTab = this.dataset.tab;

      tabs.forEach(function(t) { t.classList.remove('active'); });
      tabContents.forEach(function(c) { c.classList.remove('active'); });

      this.classList.add('active');
      document.querySelector('.form-tab-content[data-tab="' + targetTab + '"]').classList.add('active');
    });
  });

  // Open modal for new service
  newServiceBtn.addEventListener('click', function() {
    resetForm();
    modalTitle.textContent = 'Nouveau service';
    modal.hidden = false;
    document.body.style.overflow = 'hidden';
  });

  // Close modal
  function closeModal() {
    modal.hidden = true;
    document.body.style.overflow = '';
  }

  closeModalBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  document.querySelector('.modal__backdrop').addEventListener('click', closeModal);

  // Reset form
  function resetForm() {
    form.reset();
    serviceIdInput.value = '';
    quill.root.innerHTML = '';
    document.getElementById('sidebar-items-list').innerHTML = '';
    document.getElementById('formats-list').innerHTML = '';

    // Reset to first tab
    tabs.forEach(function(t) { t.classList.remove('active'); });
    tabContents.forEach(function(c) { c.classList.remove('active'); });
    tabs[0].classList.add('active');
    tabContents[0].classList.add('active');
  }

  // Add sidebar item
  document.getElementById('add-sidebar-item').addEventListener('click', function() {
    addSidebarItem('');
  });

  function addSidebarItem(value) {
    var list = document.getElementById('sidebar-items-list');
    var item = document.createElement('div');
    item.className = 'dynamic-list__item';
    item.innerHTML = '\
      <input type="text" value="' + (value || '').replace(/"/g, '&quot;') + '" placeholder="Ex: Diagnostic RSE initial" />\
      <button type="button" class="dynamic-list__remove">\
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>\
      </button>';
    list.appendChild(item);

    item.querySelector('.dynamic-list__remove').addEventListener('click', function() {
      item.remove();
    });
  }

  // Add format
  document.getElementById('add-format').addEventListener('click', function() {
    addFormat({ title: '', duration: '', description: '', image: '' });
  });

  function addFormat(format) {
    var list = document.getElementById('formats-list');
    var index = list.children.length;
    var item = document.createElement('div');
    item.className = 'format-editor-item';
    item.innerHTML = '\
      <div class="format-editor-item__header">\
        <h4>Format ' + (index + 1) + '</h4>\
        <button type="button" class="dynamic-list__remove remove-format" title="Supprimer ce format">\
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>\
        </button>\
      </div>\
      <div class="format-editor-item__fields">\
        <div class="form-field">\
          <label><span class="form-field__label">Titre *</span></label>\
          <input type="text" data-field="title" value="' + (format.title || '').replace(/"/g, '&quot;') + '" placeholder="Ex: Atelier de sensibilisation" />\
        </div>\
        <div class="form-field">\
          <label><span class="form-field__label">Durée</span></label>\
          <input type="text" data-field="duration" value="' + (format.duration || '').replace(/"/g, '&quot;') + '" placeholder="Ex: 2 à 4 heures" />\
        </div>\
        <div class="form-field form-field--full">\
          <label><span class="form-field__label">Description</span></label>\
          <textarea data-field="description" rows="3" placeholder="Description du format...">' + (format.description || '') + '</textarea>\
        </div>\
        <div class="form-field form-field--full">\
          <label><span class="form-field__label">Image</span></label>\
          <div class="image-picker-field">\
            <input type="text" data-field="image" value="' + (format.image || '').replace(/"/g, '&quot;') + '" placeholder="URL de l\'image..." />\
            <button type="button" class="btn-pick-media">Choisir</button>\
          </div>\
          <div class="image-preview" style="' + (format.image ? '' : 'display:none') + '">\
            <img src="' + (format.image || '') + '" alt="" />\
          </div>\
        </div>\
      </div>';
    list.appendChild(item);

    item.querySelector('.remove-format').addEventListener('click', function() {
      item.remove();
      updateFormatNumbers();
    });

    // Image preview on input change
    var imageInput = item.querySelector('[data-field="image"]');
    var imagePreview = item.querySelector('.image-preview');
    imageInput.addEventListener('input', function() {
      if (this.value) {
        imagePreview.style.display = 'block';
        imagePreview.querySelector('img').src = this.value;
      } else {
        imagePreview.style.display = 'none';
      }
    });

    // Media picker button
    item.querySelector('.btn-pick-media').addEventListener('click', function() {
      openMediaPicker(imageInput, imagePreview);
    });
  }

  // Media Picker
  var mediaPickerModal = document.getElementById('media-picker-modal');
  var mediaGrid = document.getElementById('media-grid');
  var mediaLoading = document.getElementById('media-loading');
  var mediaEmpty = document.getElementById('media-empty');
  var selectMediaBtn = document.getElementById('select-media-btn');
  var currentImageInput = null;
  var currentImagePreview = null;
  var selectedMediaUrl = null;

  function openMediaPicker(imageInput, imagePreview) {
    currentImageInput = imageInput;
    currentImagePreview = imagePreview;
    selectedMediaUrl = null;
    selectMediaBtn.disabled = true;
    mediaPickerModal.hidden = false;
    loadMedia();
  }

  function closeMediaPicker() {
    mediaPickerModal.hidden = true;
    currentImageInput = null;
    currentImagePreview = null;
    selectedMediaUrl = null;
  }

  document.getElementById('close-media-picker').addEventListener('click', closeMediaPicker);
  document.getElementById('cancel-media-picker').addEventListener('click', closeMediaPicker);
  document.querySelector('.media-backdrop').addEventListener('click', closeMediaPicker);

  async function loadMedia() {
    mediaLoading.style.display = 'block';
    mediaGrid.innerHTML = '';
    mediaEmpty.style.display = 'none';

    try {
      var response = await fetch('/api/media');
      var media = await response.json();

      mediaLoading.style.display = 'none';

      if (!response.ok || media.length === 0) {
        mediaEmpty.style.display = 'block';
        return;
      }

      // Filter to only show images
      var images = media.filter(function(m) {
        return m.type && m.type.startsWith('image/');
      });

      if (images.length === 0) {
        mediaEmpty.style.display = 'block';
        return;
      }

      images.forEach(function(m) {
        var item = document.createElement('div');
        item.className = 'media-picker-item';
        item.dataset.url = m.url;
        item.innerHTML = '<img src="' + m.url + '" alt="' + (m.filename || '').replace(/"/g, '&quot;') + '" loading="lazy" />';
        item.addEventListener('click', function() {
          document.querySelectorAll('.media-picker-item').forEach(function(i) {
            i.classList.remove('selected');
          });
          item.classList.add('selected');
          selectedMediaUrl = m.url;
          selectMediaBtn.disabled = false;
        });
        mediaGrid.appendChild(item);
      });
    } catch (error) {
      mediaLoading.style.display = 'none';
      mediaEmpty.textContent = 'Erreur lors du chargement des médias.';
      mediaEmpty.style.display = 'block';
    }
  }

  selectMediaBtn.addEventListener('click', function() {
    if (selectedMediaUrl && currentImageInput) {
      currentImageInput.value = selectedMediaUrl;
      if (currentImagePreview) {
        currentImagePreview.style.display = 'block';
        currentImagePreview.querySelector('img').src = selectedMediaUrl;
      }
      closeMediaPicker();
    }
  });

  function updateFormatNumbers() {
    var items = document.querySelectorAll('.format-editor-item');
    items.forEach(function(item, index) {
      item.querySelector('h4').textContent = 'Format ' + (index + 1);
    });
  }

  // Edit service
  servicesList.addEventListener('click', function(e) {
    var editBtn = e.target.closest('.edit-service-btn');
    if (editBtn) {
      var serviceId = editBtn.dataset.id;
      loadService(serviceId);
    }

    var deleteBtn = e.target.closest('.delete-service-btn');
    if (deleteBtn) {
      var id = deleteBtn.dataset.id;
      var title = deleteBtn.dataset.title;
      if (confirm('Supprimer "' + title + '" ?')) {
        deleteService(id);
      }
    }
  });

  async function loadService(id) {
    try {
      var response = await fetch('/api/services/' + id);
      var service = await response.json();

      if (!response.ok) {
        throw new Error(service.error || 'Erreur lors du chargement');
      }

      // Fill form
      serviceIdInput.value = service.id;
      document.getElementById('service-title').value = service.title || '';
      document.getElementById('service-slug').value = service.slug || '';
      document.getElementById('service-summary').value = service.summary || '';
      document.getElementById('service-page-title').value = service.pageTitle || '';
      document.getElementById('service-page-description').value = service.pageDescription || '';
      document.getElementById('service-published').value = service.published ? 'true' : 'false';
      document.getElementById('service-sidebar-title').value = service.sidebarTitle || '';
      document.getElementById('service-cta-title').value = service.ctaTitle || '';
      document.getElementById('service-cta-text').value = service.ctaText || '';

      // Set description in Quill
      quill.root.innerHTML = service.description || '';

      // Load sidebar items
      var sidebarList = document.getElementById('sidebar-items-list');
      sidebarList.innerHTML = '';
      if (service.sidebarItems && service.sidebarItems.length > 0) {
        service.sidebarItems.forEach(function(item) {
          addSidebarItem(item);
        });
      }

      // Load formats
      var formatsList = document.getElementById('formats-list');
      formatsList.innerHTML = '';
      if (service.formats && service.formats.length > 0) {
        service.formats.forEach(function(format) {
          addFormat(format);
        });
      }

      modalTitle.textContent = 'Modifier le service';
      modal.hidden = false;
      document.body.style.overflow = 'hidden';

    } catch (error) {
      showMessage(error.message, 'error');
    }
  }

  // Save service
  saveBtn.addEventListener('click', async function() {
    var id = serviceIdInput.value;
    var title = document.getElementById('service-title').value.trim();
    var slug = document.getElementById('service-slug').value.trim();
    var summary = document.getElementById('service-summary').value.trim();

    if (!title || !slug || !summary) {
      showMessage('Veuillez remplir tous les champs obligatoires', 'error');
      return;
    }

    // Get sidebar items
    var sidebarItems = [];
    document.querySelectorAll('#sidebar-items-list input').forEach(function(input) {
      if (input.value.trim()) {
        sidebarItems.push(input.value.trim());
      }
    });

    // Get formats
    var formats = [];
    document.querySelectorAll('.format-editor-item').forEach(function(item) {
      var format = {
        title: item.querySelector('[data-field="title"]').value.trim(),
        duration: item.querySelector('[data-field="duration"]').value.trim(),
        description: item.querySelector('[data-field="description"]').value.trim(),
        image: item.querySelector('[data-field="image"]').value.trim()
      };
      if (format.title) {
        formats.push(format);
      }
    });

    var data = {
      title: title,
      slug: slug,
      summary: summary,
      description: quill.root.innerHTML,
      pageTitle: document.getElementById('service-page-title').value.trim() || null,
      pageDescription: document.getElementById('service-page-description').value.trim() || null,
      published: document.getElementById('service-published').value === 'true',
      sidebarTitle: document.getElementById('service-sidebar-title').value.trim() || null,
      sidebarItems: sidebarItems,
      ctaTitle: document.getElementById('service-cta-title').value.trim() || null,
      ctaText: document.getElementById('service-cta-text').value.trim() || null,
      formats: formats
    };

    saveBtn.disabled = true;
    saveBtn.textContent = 'Enregistrement...';

    try {
      var url = id ? '/api/services/' + id : '/api/services';
      var method = id ? 'PUT' : 'POST';

      var response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      var result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Erreur lors de la sauvegarde');
      }

      showMessage('Service enregistré avec succès !', 'success');
      closeModal();
      window.location.reload();

    } catch (error) {
      showMessage(error.message, 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Enregistrer';
    }
  });

  // Delete service
  async function deleteService(id) {
    try {
      var response = await fetch('/api/services/' + id, { method: 'DELETE' });
      var result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Erreur lors de la suppression');
      }

      showMessage('Service supprimé', 'success');
      window.location.reload();

    } catch (error) {
      showMessage(error.message, 'error');
    }
  }

  function showMessage(text, type) {
    messageEl.textContent = text;
    messageEl.className = 'form-message ' + type;
    messageEl.style.display = 'block';
    messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Auto-generate slug from title
  document.getElementById('service-title').addEventListener('input', function() {
    if (!serviceIdInput.value) {
      var slugInput = document.getElementById('service-slug');
      if (!slugInput.dataset.manuallyEdited) {
        slugInput.value = this.value
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
      }
    }
  });

  document.getElementById('service-slug').addEventListener('input', function() {
    this.dataset.manuallyEdited = 'true';
  });
</script>
