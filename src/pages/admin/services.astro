---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Default services content
const defaultServices = [
  {
    id: 'strategie-rse',
    title: 'Stratégie RSE',
    summary: 'Construisez une démarche de responsabilité sociétale structurée, alignée avec vos valeurs et créatrice de valeur.',
    href: '/services/strategie-rse',
  },
  {
    id: 'transition-ecologique',
    title: 'Transition écologique',
    summary: 'Réduisez votre impact environnemental avec un accompagnement sur le bilan carbone, l\'économie circulaire et l\'éco-conception.',
    href: '/services/transition-ecologique',
  },
  {
    id: 'formation',
    title: 'Formation & sensibilisation',
    summary: 'Engagez vos équipes avec des formations adaptées aux enjeux du développement durable.',
    href: '/services/formation',
  },
];

// Get existing services content or use defaults
const servicesPage = await prisma.pageContent.findUnique({
  where: { slug: 'services' },
});

const services = servicesPage?.content as typeof defaultServices || defaultServices;
---

<Layout title="Gestion des services">
  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Services</h1>
        <p>Modifiez le contenu des services affichés sur le site</p>
      </div>
      <a href="/admin" class="btn btn--outline">Retour</a>
    </header>

    <div id="form-message" class="form-message" style="display: none;"></div>

    <div class="services-editor">
      {services.map((service, index) => (
        <div class="service-editor" data-index={index}>
          <div class="service-editor__header">
            <span class="service-editor__number">{String(index + 1).padStart(2, '0')}</span>
            <h3>{service.title}</h3>
          </div>

          <div class="form-group">
            <label for={`title-${index}`}>Titre du service</label>
            <input
              type="text"
              id={`title-${index}`}
              name="title"
              value={service.title}
              data-field="title"
            />
          </div>

          <div class="form-group">
            <label for={`summary-${index}`}>Description courte</label>
            <textarea
              id={`summary-${index}`}
              name="summary"
              rows="3"
              data-field="summary"
            >{service.summary}</textarea>
          </div>

          <div class="form-group">
            <label for={`href-${index}`}>Lien vers la page de détail</label>
            <input
              type="text"
              id={`href-${index}`}
              name="href"
              value={service.href}
              data-field="href"
            />
          </div>
        </div>
      ))}
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn--primary" id="save-btn">Enregistrer les modifications</button>
    </div>
  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-lg);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .services-editor {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .service-editor {
    background: var(--color-surface);
    padding: var(--space-6);
    border: var(--border-width) solid var(--color-border-light);
  }

  .service-editor__header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border-light);
  }

  .service-editor__number {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
  }

  .service-editor__header h3 {
    font-size: var(--font-size-lg);
    margin: 0;
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--color-border-light);
    font-size: var(--font-size-base);
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-message {
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
  }

  .form-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .form-actions {
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
  }
</style>

<script>
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
  const messageEl = document.getElementById('form-message') as HTMLElement;

  saveBtn.addEventListener('click', async () => {
    messageEl.style.display = 'none';
    saveBtn.disabled = true;
    saveBtn.textContent = 'Enregistrement...';

    // Collect all service data
    const serviceEditors = document.querySelectorAll('.service-editor');
    const services: Array<{id: string; title: string; summary: string; href: string}> = [];

    serviceEditors.forEach((editor, index) => {
      const title = (editor.querySelector('[data-field="title"]') as HTMLInputElement).value;
      const summary = (editor.querySelector('[data-field="summary"]') as HTMLTextAreaElement).value;
      const href = (editor.querySelector('[data-field="href"]') as HTMLInputElement).value;

      // Generate id from href
      const id = href.split('/').pop() || `service-${index}`;

      services.push({ id, title, summary, href });
    });

    try {
      const response = await fetch('/api/pages/services', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: services }),
      });

      const result = await response.json();

      if (response.ok) {
        messageEl.textContent = 'Services enregistrés avec succès !';
        messageEl.className = 'form-message success';
      } else {
        throw new Error(result.error || 'Erreur lors de la sauvegarde');
      }
    } catch (error) {
      messageEl.textContent = error instanceof Error ? error.message : 'Erreur lors de la sauvegarde';
      messageEl.className = 'form-message error';
    } finally {
      messageEl.style.display = 'block';
      saveBtn.disabled = false;
      saveBtn.textContent = 'Enregistrer les modifications';
    }
  });
</script>
