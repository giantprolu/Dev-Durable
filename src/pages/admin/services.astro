---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Default services content
const defaultServices = [
  {
    id: 'strategie-rse',
    title: 'Stratégie RSE',
    summary: 'Construisez une démarche de responsabilité sociétale structurée, alignée avec vos valeurs et créatrice de valeur.',
    href: '/services/strategie-rse',
  },
  {
    id: 'transition-ecologique',
    title: 'Transition écologique',
    summary: 'Réduisez votre impact environnemental avec un accompagnement sur le bilan carbone, l\'économie circulaire et l\'éco-conception.',
    href: '/services/transition-ecologique',
  },
  {
    id: 'formation',
    title: 'Formation & sensibilisation',
    summary: 'Engagez vos équipes avec des formations adaptées aux enjeux du développement durable.',
    href: '/services/formation',
  },
];

// Get existing services content or use defaults
const servicesPage = await prisma.pageContent.findUnique({
  where: { slug: 'services' },
});

const services = servicesPage?.content as typeof defaultServices || defaultServices;
---

<Layout title="Gestion des services">
  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Services</h1>
        <p>{services.length} service{services.length > 1 ? 's' : ''} configuré{services.length > 1 ? 's' : ''}</p>
      </div>
      <div class="admin-page__actions">
        <a href="/admin" class="btn btn--back">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Retour
        </a>
        <button type="button" class="btn btn--primary" id="save-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Enregistrer tout
        </button>
      </div>
    </header>

    <div id="form-message" class="form-message" style="display: none;"></div>

    <div class="services-grid" id="services-editor">
      {services.map((service, index) => (
        <article class="service-card-editor" data-index={index}>
          <header class="service-card-editor__header">
            <span class="service-card-editor__badge">{String(index + 1).padStart(2, '0')}</span>
            <div class="service-card-editor__actions">
              <button type="button" class="btn-icon btn-icon--move" title="Déplacer" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
              </button>
              <button type="button" class="btn-icon btn-icon--delete delete-service-btn" title="Supprimer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </header>

          <div class="service-card-editor__preview">
            <h3 class="preview-title">{service.title}</h3>
          </div>

          <div class="service-card-editor__fields">
            <div class="field">
              <label for={`title-${index}`}>
                <span class="field__label">Titre</span>
                <span class="field__required">*</span>
              </label>
              <input
                type="text"
                id={`title-${index}`}
                value={service.title}
                data-field="title"
                placeholder="Ex: Stratégie RSE"
                required
              />
            </div>

            <div class="field">
              <label for={`summary-${index}`}>
                <span class="field__label">Description</span>
                <span class="field__required">*</span>
              </label>
              <textarea
                id={`summary-${index}`}
                rows="3"
                data-field="summary"
                placeholder="Décrivez brièvement ce service..."
                required
              >{service.summary}</textarea>
              <span class="field__hint">Affiché sur la page d'accueil et la liste des services</span>
            </div>

            <div class="field">
              <label for={`href-${index}`}>
                <span class="field__label">Lien</span>
              </label>
              <div class="field__input-group">
                <span class="field__prefix">/services/</span>
                <input
                  type="text"
                  id={`href-${index}`}
                  value={service.href.replace('/services/', '')}
                  data-field="href"
                  placeholder="mon-service"
                />
              </div>
              <span class="field__hint">Pages : strategie-rse, transition-ecologique, formation</span>
            </div>
          </div>
        </article>
      ))}
    </div>

    <button type="button" class="add-service-btn" id="add-service-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      <span>Ajouter un service</span>
    </button>
  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-xl);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .admin-page__actions {
    display: flex;
    gap: var(--space-2);
    align-items: center;
  }

  .form-message {
    padding: var(--space-4);
    margin-bottom: var(--space-6);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    border: var(--border-width-thick) solid;
  }

  .form-message.success {
    background: var(--color-primary);
    color: var(--color-ink);
    border-color: var(--color-ink);
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #721c24;
  }

  /* Services Grid */
  .services-grid {
    display: grid;
    gap: var(--space-6);
    margin-bottom: var(--space-6);
  }

  @media (min-width: 768px) {
    .services-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1200px) {
    .services-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* Service Card Editor */
  .service-card-editor {
    background: var(--color-white);
    border: var(--border-width-thick) solid var(--color-ink);
    display: flex;
    flex-direction: column;
  }

  .service-card-editor__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    background: var(--color-ink);
    color: var(--color-white);
  }

  .service-card-editor__badge {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
  }

  .service-card-editor__actions {
    display: flex;
    gap: var(--space-2);
  }

  .btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: transparent;
    border: 2px solid var(--color-charcoal);
    color: var(--color-warm-gray);
    cursor: pointer;
    transition: all 0.1s;
  }

  .btn-icon:hover:not(:disabled) {
    background: var(--color-white);
    border-color: var(--color-white);
    color: var(--color-ink);
  }

  .btn-icon:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .btn-icon--delete:hover:not(:disabled) {
    background: var(--color-error);
    border-color: var(--color-error);
    color: var(--color-white);
  }

  .service-card-editor__preview {
    padding: var(--space-4);
    border-bottom: 2px solid var(--color-sand);
    background: var(--color-cream);
  }

  .preview-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    margin: 0;
    color: var(--color-ink);
  }

  .service-card-editor__fields {
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    flex: 1;
  }

  /* Fields */
  .field {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .field label {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .field__label {
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    color: var(--color-ink);
  }

  .field__required {
    color: var(--color-error);
    font-weight: var(--font-weight-bold);
  }

  .field input,
  .field textarea {
    width: 100%;
    padding: var(--space-3);
    border: var(--border-width) solid var(--color-border);
    font-size: var(--font-size-base);
    font-family: inherit;
    background: var(--color-white);
    transition: border-color 0.1s;
  }

  .field input:focus,
  .field textarea:focus {
    outline: none;
    border-color: var(--color-ink);
  }

  .field textarea {
    resize: vertical;
    min-height: 80px;
  }

  .field__hint {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .field__input-group {
    display: flex;
    align-items: stretch;
  }

  .field__prefix {
    display: flex;
    align-items: center;
    padding: 0 var(--space-3);
    background: var(--color-sand);
    border: var(--border-width) solid var(--color-border);
    border-right: none;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    font-family: monospace;
  }

  .field__input-group input {
    flex: 1;
  }

  /* Add Service Button */
  .add-service-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    width: 100%;
    padding: var(--space-6);
    background: var(--color-cream);
    border: 3px dashed var(--color-border);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.1s;
  }

  .add-service-btn:hover {
    background: var(--color-primary);
    border-color: var(--color-ink);
    border-style: solid;
    color: var(--color-ink);
  }

  .add-service-btn svg {
    transition: transform 0.1s;
  }

  .add-service-btn:hover svg {
    transform: scale(1.2);
  }
</style>

<script is:inline>
  var saveBtn = document.getElementById('save-btn');
  var addServiceBtn = document.getElementById('add-service-btn');
  var messageEl = document.getElementById('form-message');
  var servicesEditor = document.getElementById('services-editor');

  var serviceCount = document.querySelectorAll('.service-card-editor').length;

  // Function to update service numbers
  function updateServiceNumbers() {
    var editors = document.querySelectorAll('.service-card-editor');
    editors.forEach(function(editor, index) {
      var badgeEl = editor.querySelector('.service-card-editor__badge');
      if (badgeEl) {
        badgeEl.textContent = String(index + 1).padStart(2, '0');
      }
    });
  }

  // Function to create a new service editor
  function createServiceEditor(index) {
    var template = '\
      <article class="service-card-editor" data-index="' + index + '">\
        <header class="service-card-editor__header">\
          <span class="service-card-editor__badge">' + String(index + 1).padStart(2, '0') + '</span>\
          <div class="service-card-editor__actions">\
            <button type="button" class="btn-icon btn-icon--move" title="Déplacer" disabled>\
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>\
            </button>\
            <button type="button" class="btn-icon btn-icon--delete delete-service-btn" title="Supprimer">\
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>\
            </button>\
          </div>\
        </header>\
        <div class="service-card-editor__preview">\
          <h3 class="preview-title">Nouveau service</h3>\
        </div>\
        <div class="service-card-editor__fields">\
          <div class="field">\
            <label for="title-' + index + '">\
              <span class="field__label">Titre</span>\
              <span class="field__required">*</span>\
            </label>\
            <input type="text" id="title-' + index + '" value="" data-field="title" placeholder="Ex: Stratégie RSE" required />\
          </div>\
          <div class="field">\
            <label for="summary-' + index + '">\
              <span class="field__label">Description</span>\
              <span class="field__required">*</span>\
            </label>\
            <textarea id="summary-' + index + '" rows="3" data-field="summary" placeholder="Décrivez brièvement ce service..." required></textarea>\
            <span class="field__hint">Affiché sur la page d\'accueil et la liste des services</span>\
          </div>\
          <div class="field">\
            <label for="href-' + index + '">\
              <span class="field__label">Lien</span>\
            </label>\
            <div class="field__input-group">\
              <span class="field__prefix">/services/</span>\
              <input type="text" id="href-' + index + '" value="" data-field="href" placeholder="mon-service" />\
            </div>\
            <span class="field__hint">Pages : strategie-rse, transition-ecologique, formation</span>\
          </div>\
        </div>\
      </article>';

    var div = document.createElement('div');
    div.innerHTML = template.trim();
    return div.firstChild;
  }

  // Add new service
  addServiceBtn.addEventListener('click', function() {
    var newEditor = createServiceEditor(serviceCount);
    servicesEditor.appendChild(newEditor);
    serviceCount++;

    newEditor.scrollIntoView({ behavior: 'smooth', block: 'center' });
    var titleInput = newEditor.querySelector('[data-field="title"]');
    setTimeout(function() { titleInput && titleInput.focus(); }, 300);
  });

  // Delete service (using event delegation)
  servicesEditor.addEventListener('click', function(e) {
    var deleteBtn = e.target.closest('.delete-service-btn');
    if (!deleteBtn) return;

    var editor = deleteBtn.closest('.service-card-editor');
    if (!editor) return;

    var editors = document.querySelectorAll('.service-card-editor');
    if (editors.length <= 1) {
      alert('Vous devez garder au moins un service.');
      return;
    }

    var titleInput = editor.querySelector('[data-field="title"]');
    var title = titleInput ? titleInput.value : 'ce service';
    if (!confirm('Supprimer "' + title + '" ?')) return;

    editor.remove();
    updateServiceNumbers();
  });

  // Update title in preview when editing
  servicesEditor.addEventListener('input', function(e) {
    if (e.target.dataset.field === 'title') {
      var editor = e.target.closest('.service-card-editor');
      var previewTitle = editor && editor.querySelector('.preview-title');
      if (previewTitle) {
        previewTitle.textContent = e.target.value || 'Nouveau service';
      }
    }
  });

  // Save services
  saveBtn.addEventListener('click', async function() {
    messageEl.style.display = 'none';
    saveBtn.disabled = true;
    saveBtn.textContent = 'Enregistrement...';

    var serviceEditors = document.querySelectorAll('.service-card-editor');
    var services = [];

    serviceEditors.forEach(function(editor, index) {
      var title = editor.querySelector('[data-field="title"]').value;
      var summary = editor.querySelector('[data-field="summary"]').value;
      var hrefInput = editor.querySelector('[data-field="href"]').value;
      var href = '/services/' + hrefInput;
      var id = hrefInput || ('service-' + index);

      services.push({ id: id, title: title, summary: summary, href: href });
    });

    try {
      var response = await fetch('/api/pages/services', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: services }),
      });

      var result = await response.json();

      if (response.ok) {
        messageEl.textContent = 'Services enregistrés avec succès !';
        messageEl.className = 'form-message success';
      } else {
        throw new Error(result.error || 'Erreur lors de la sauvegarde');
      }
    } catch (error) {
      messageEl.textContent = error.message || 'Erreur lors de la sauvegarde';
      messageEl.className = 'form-message error';
    } finally {
      messageEl.style.display = 'block';
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Enregistrer tout';
    }
  });
</script>
