---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Default services content
const defaultServices = [
  {
    id: 'strategie-rse',
    title: 'Stratégie RSE',
    summary: 'Construisez une démarche de responsabilité sociétale structurée, alignée avec vos valeurs et créatrice de valeur.',
    href: '/services/strategie-rse',
  },
  {
    id: 'transition-ecologique',
    title: 'Transition écologique',
    summary: 'Réduisez votre impact environnemental avec un accompagnement sur le bilan carbone, l\'économie circulaire et l\'éco-conception.',
    href: '/services/transition-ecologique',
  },
  {
    id: 'formation',
    title: 'Formation & sensibilisation',
    summary: 'Engagez vos équipes avec des formations adaptées aux enjeux du développement durable.',
    href: '/services/formation',
  },
];

// Get existing services content or use defaults
const servicesPage = await prisma.pageContent.findUnique({
  where: { slug: 'services' },
});

const services = servicesPage?.content as typeof defaultServices || defaultServices;
---

<Layout title="Gestion des services">
  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Services</h1>
        <p>Modifiez le contenu des services affichés sur le site</p>
      </div>
      <div class="admin-page__actions">
        <a href="/admin" class="btn btn--back">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Retour
        </a>
        <button type="button" class="btn btn--outline" id="add-service-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Ajouter un service
        </button>
        <button type="button" class="btn btn--primary" id="save-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Enregistrer
        </button>
      </div>
    </header>

    <div id="form-message" class="form-message" style="display: none;"></div>

    <div class="services-editor" id="services-editor">
      {services.map((service, index) => (
        <div class="service-editor" data-index={index}>
          <div class="service-editor__header">
            <span class="service-editor__number">{String(index + 1).padStart(2, '0')}</span>
            <h3 class="service-editor__title">{service.title}</h3>
            <button type="button" class="btn btn--sm btn--danger delete-service-btn" title="Supprimer ce service">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>

          <div class="form-group">
            <label for={`title-${index}`}>Titre du service</label>
            <input
              type="text"
              id={`title-${index}`}
              name="title"
              value={service.title}
              data-field="title"
            />
          </div>

          <div class="form-group">
            <label for={`summary-${index}`}>Description courte</label>
            <textarea
              id={`summary-${index}`}
              name="summary"
              rows="3"
              data-field="summary"
            >{service.summary}</textarea>
          </div>

          <div class="form-group">
            <label for={`href-${index}`}>Lien vers la page de détail</label>
            <input
              type="text"
              id={`href-${index}`}
              name="href"
              value={service.href}
              data-field="href"
            />
          </div>
        </div>
      ))}
    </div>

  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-lg);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .admin-page__actions {
    display: flex;
    gap: var(--space-2);
    align-items: center;
  }

  .services-editor {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .service-editor {
    background: var(--color-surface);
    padding: var(--space-6);
    border: var(--border-width) solid var(--color-border-light);
  }

  .service-editor__header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border-light);
  }

  .service-editor__number {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
  }

  .service-editor__title {
    font-size: var(--font-size-lg);
    margin: 0;
    flex: 1;
  }

  .delete-service-btn {
    flex-shrink: 0;
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--color-border-light);
    font-size: var(--font-size-base);
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-message {
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
  }

  .form-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>

<script>
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
  const addServiceBtn = document.getElementById('add-service-btn') as HTMLButtonElement;
  const messageEl = document.getElementById('form-message') as HTMLElement;
  const servicesEditor = document.getElementById('services-editor') as HTMLElement;

  let serviceCount = document.querySelectorAll('.service-editor').length;

  // Function to update service numbers
  function updateServiceNumbers() {
    const editors = document.querySelectorAll('.service-editor');
    editors.forEach((editor, index) => {
      const numberEl = editor.querySelector('.service-editor__number');
      if (numberEl) {
        numberEl.textContent = String(index + 1).padStart(2, '0');
      }
    });
  }

  // Function to create a new service editor
  function createServiceEditor(index: number) {
    const template = `
      <div class="service-editor" data-index="${index}">
        <div class="service-editor__header">
          <span class="service-editor__number">${String(index + 1).padStart(2, '0')}</span>
          <h3 class="service-editor__title">Nouveau service</h3>
          <button type="button" class="btn btn--sm btn--danger delete-service-btn" title="Supprimer ce service">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </div>

        <div class="form-group">
          <label for="title-${index}">Titre du service</label>
          <input
            type="text"
            id="title-${index}"
            name="title"
            value=""
            data-field="title"
            placeholder="Titre du service"
          />
        </div>

        <div class="form-group">
          <label for="summary-${index}">Description courte</label>
          <textarea
            id="summary-${index}"
            name="summary"
            rows="3"
            data-field="summary"
            placeholder="Description courte du service"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="href-${index}">Lien vers la page de détail</label>
          <input
            type="text"
            id="href-${index}"
            name="href"
            value="/services/"
            data-field="href"
            placeholder="/services/mon-service"
          />
        </div>
      </div>
    `;

    const div = document.createElement('div');
    div.innerHTML = template.trim();
    return div.firstChild as HTMLElement;
  }

  // Add new service
  addServiceBtn.addEventListener('click', () => {
    const newEditor = createServiceEditor(serviceCount);
    servicesEditor.appendChild(newEditor);
    serviceCount++;

    // Scroll to the new service
    newEditor.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Focus the title input
    const titleInput = newEditor.querySelector('[data-field="title"]') as HTMLInputElement;
    setTimeout(() => titleInput?.focus(), 300);
  });

  // Delete service (using event delegation)
  servicesEditor.addEventListener('click', (e) => {
    const deleteBtn = (e.target as HTMLElement).closest('.delete-service-btn');
    if (!deleteBtn) return;

    const editor = deleteBtn.closest('.service-editor');
    if (!editor) return;

    const editors = document.querySelectorAll('.service-editor');
    if (editors.length <= 1) {
      alert('Vous devez garder au moins un service.');
      return;
    }

    const title = (editor.querySelector('[data-field="title"]') as HTMLInputElement)?.value || 'ce service';
    if (!confirm(`Êtes-vous sûr de vouloir supprimer "${title}" ?`)) {
      return;
    }

    editor.remove();
    updateServiceNumbers();
  });

  // Update title in header when editing
  servicesEditor.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.dataset.field === 'title') {
      const editor = target.closest('.service-editor');
      const titleEl = editor?.querySelector('.service-editor__title');
      if (titleEl) {
        titleEl.textContent = target.value || 'Nouveau service';
      }
    }
  });

  // Save services
  saveBtn.addEventListener('click', async () => {
    messageEl.style.display = 'none';
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Enregistrement...';

    // Collect all service data
    const serviceEditors = document.querySelectorAll('.service-editor');
    const services: Array<{id: string; title: string; summary: string; href: string}> = [];

    serviceEditors.forEach((editor, index) => {
      const title = (editor.querySelector('[data-field="title"]') as HTMLInputElement).value;
      const summary = (editor.querySelector('[data-field="summary"]') as HTMLTextAreaElement).value;
      const href = (editor.querySelector('[data-field="href"]') as HTMLInputElement).value;

      // Generate id from href
      const id = href.split('/').pop() || `service-${index}`;

      services.push({ id, title, summary, href });
    });

    try {
      const response = await fetch('/api/pages/services', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: services }),
      });

      const result = await response.json();

      if (response.ok) {
        messageEl.textContent = 'Services enregistrés avec succès !';
        messageEl.className = 'form-message success';
      } else {
        throw new Error(result.error || 'Erreur lors de la sauvegarde');
      }
    } catch (error) {
      messageEl.textContent = error instanceof Error ? error.message : 'Erreur lors de la sauvegarde';
      messageEl.className = 'form-message error';
    } finally {
      messageEl.style.display = 'block';
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Enregistrer';
    }
  });
</script>
