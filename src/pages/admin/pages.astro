---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Get existing page content or defaults
const homePage = await prisma.pageContent.findUnique({ where: { slug: 'home' } });
const aboutPage = await prisma.pageContent.findUnique({ where: { slug: 'about' } });
const contactPage = await prisma.pageContent.findUnique({ where: { slug: 'contact' } });

const homeContent = (homePage?.content as Record<string, string>) || {
  heroTitle: 'Accompagnons ensemble votre transition vers un modèle durable',
  heroSubtitle: 'AC-ingiénierie vous guide dans votre démarche de développement durable, RSE et transition écologique. Des solutions pragmatiques pour un impact positif et mesurable.',
  ctaText: 'Découvrir nos services',
  secondaryCtaText: 'Nous contacter',
  aboutTitle: 'Pourquoi AC-ingiénierie ?',
  aboutText: 'Nous croyons que la transition écologique et sociale est une opportunité de repenser en profondeur votre modèle d\'entreprise.',
};

const aboutContent = (aboutPage?.content as Record<string, string>) || {
  title: 'À propos',
  subtitle: 'Une conviction simple : le développement durable est un levier de transformation, pas une contrainte.',
  content: '',
};

const contactContent = (contactPage?.content as Record<string, string>) || {
  title: 'Contact',
  subtitle: 'Un projet, une question ? Prenons le temps d\'en discuter.',
  introTitle: 'Échangeons',
  introText: 'Que vous soyez au début de votre réflexion ou que vous ayez un projet précis, nous sommes à votre écoute.',
};
---

<Layout title="Gestion des pages">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Pages</h1>
        <p>Modifiez le contenu de toutes les pages du site</p>
      </div>
      <a href="/admin" class="btn btn--back">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Retour
      </a>
    </header>

    <div class="page-tabs">
      <button class="tab-btn active" data-tab="home">Accueil</button>
      <button class="tab-btn" data-tab="about">À propos</button>
      <button class="tab-btn" data-tab="contact">Contact</button>
    </div>

    <div class="page-sections">
      <!-- HOME PAGE -->
      <section class="page-section active" id="section-home">
        <div class="section-header">
          <h2>Page d'accueil</h2>
          <a href="/" target="_blank" class="btn btn--outline btn--sm">Voir la page</a>
        </div>
        <form id="home-form" class="page-form" data-slug="home">
          <div id="home-message" class="form-message" style="display: none;"></div>

          <fieldset class="fieldset">
            <legend>Section Hero</legend>
            <div class="form-group">
              <label for="home-heroTitle">Titre principal *</label>
              <input type="text" id="home-heroTitle" name="heroTitle" value={homeContent.heroTitle} required />
            </div>

            <div class="form-group">
              <label for="home-heroSubtitle">Sous-titre</label>
              <textarea id="home-heroSubtitle" name="heroSubtitle" rows="3">{homeContent.heroSubtitle}</textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="home-ctaText">Bouton principal</label>
                <input type="text" id="home-ctaText" name="ctaText" value={homeContent.ctaText} />
              </div>
              <div class="form-group">
                <label for="home-secondaryCtaText">Bouton secondaire</label>
                <input type="text" id="home-secondaryCtaText" name="secondaryCtaText" value={homeContent.secondaryCtaText} />
              </div>
            </div>
          </fieldset>

          <button type="submit" class="btn btn--primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Enregistrer
          </button>
        </form>
      </section>

      <!-- ABOUT PAGE -->
      <section class="page-section" id="section-about">
        <div class="section-header">
          <h2>Page À propos</h2>
          <a href="/a-propos" target="_blank" class="btn btn--outline btn--sm">Voir la page</a>
        </div>
        <form id="about-form" class="page-form" data-slug="about">
          <div id="about-message" class="form-message" style="display: none;"></div>

          <fieldset class="fieldset">
            <legend>En-tête</legend>
            <div class="form-group">
              <label for="about-title">Titre *</label>
              <input type="text" id="about-title" name="title" value={aboutContent.title} required />
            </div>

            <div class="form-group">
              <label for="about-subtitle">Sous-titre</label>
              <input type="text" id="about-subtitle" name="subtitle" value={aboutContent.subtitle} />
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>Contenu principal</legend>
            <div class="form-group">
              <label>Contenu de la page</label>
              <div id="about-editor" class="quill-editor"></div>
              <input type="hidden" id="about-content" name="content" value={aboutContent.content} />
            </div>
          </fieldset>

          <button type="submit" class="btn btn--primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Enregistrer
          </button>
        </form>
      </section>

      <!-- CONTACT PAGE -->
      <section class="page-section" id="section-contact">
        <div class="section-header">
          <h2>Page Contact</h2>
          <a href="/contact" target="_blank" class="btn btn--outline btn--sm">Voir la page</a>
        </div>
        <form id="contact-form" class="page-form" data-slug="contact">
          <div id="contact-message" class="form-message" style="display: none;"></div>

          <fieldset class="fieldset">
            <legend>En-tête</legend>
            <div class="form-group">
              <label for="contact-title">Titre *</label>
              <input type="text" id="contact-title" name="title" value={contactContent.title} required />
            </div>

            <div class="form-group">
              <label for="contact-subtitle">Sous-titre</label>
              <input type="text" id="contact-subtitle" name="subtitle" value={contactContent.subtitle} />
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>Section introduction</legend>
            <div class="form-group">
              <label for="contact-introTitle">Titre</label>
              <input type="text" id="contact-introTitle" name="introTitle" value={contactContent.introTitle} />
            </div>
            <div class="form-group">
              <label for="contact-introText">Texte</label>
              <textarea id="contact-introText" name="introText" rows="3">{contactContent.introText}</textarea>
            </div>
          </fieldset>

          <p class="info-note">
            <strong>Note :</strong> L'email de contact et les réseaux sociaux se modifient dans
            <a href="/admin/settings">Paramètres du site</a>.
          </p>

          <button type="submit" class="btn btn--primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Enregistrer
          </button>
        </form>
      </section>
    </div>
  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-lg);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Tabs */
  .page-tabs {
    display: flex;
    gap: 0;
    margin-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-ink);
  }

  .tab-btn {
    padding: var(--space-3) var(--space-6);
    background: var(--color-sand);
    border: var(--border-width-thick) solid var(--color-ink);
    border-bottom: none;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-secondary);
    cursor: pointer;
    margin-bottom: -4px;
    transition: all 0.1s;
  }

  .tab-btn:hover {
    background: var(--color-stone);
  }

  .tab-btn.active {
    background: var(--color-white);
    color: var(--color-ink);
    border-bottom-color: var(--color-white);
  }

  /* Sections */
  .page-sections {
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
  }

  .page-section {
    display: none;
    background: var(--color-white);
    padding: var(--space-6);
    border: var(--border-width-thick) solid var(--color-ink);
  }

  .page-section.active {
    display: block;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--color-sand);
  }

  .section-header h2 {
    font-size: var(--font-size-xl);
    margin: 0;
  }

  /* Fieldset */
  .fieldset {
    border: 2px solid var(--color-sand);
    padding: var(--space-5);
    margin-bottom: var(--space-6);
  }

  .fieldset legend {
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    color: var(--color-primary);
    padding: 0 var(--space-2);
  }

  .form-row {
    display: grid;
    gap: var(--space-4);
  }

  @media (min-width: 768px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group:last-child {
    margin-bottom: 0;
  }

  .form-group label {
    display: block;
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-2);
    color: var(--color-ink);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-3);
    border: var(--border-width) solid var(--color-border);
    font-size: var(--font-size-base);
    font-family: inherit;
    background: var(--color-white);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-ink);
  }

  /* Quill Editor */
  .quill-editor {
    height: 300px;
    background: var(--color-white);
  }

  .ql-toolbar.ql-snow {
    border: var(--border-width) solid var(--color-border);
    border-bottom: none;
    background: var(--color-cream);
  }

  .ql-container.ql-snow {
    border: var(--border-width) solid var(--color-border);
    font-family: var(--font-sans);
    font-size: var(--font-size-base);
  }

  .form-message {
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    border: var(--border-width-thick) solid;
  }

  .form-message.success {
    background: var(--color-primary);
    color: var(--color-ink);
    border-color: var(--color-ink);
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #721c24;
  }

  .info-note {
    padding: var(--space-4);
    background: var(--color-cream);
    border-left: 4px solid var(--color-primary);
    margin-bottom: var(--space-6);
    font-size: var(--font-size-sm);
  }

  .info-note a {
    color: var(--color-ink);
  }
</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script is:inline>
  // Tab switching
  var tabBtns = document.querySelectorAll('.tab-btn');
  var sections = document.querySelectorAll('.page-section');

  tabBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var tabName = btn.dataset.tab;

      tabBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');

      sections.forEach(function(s) { s.classList.remove('active'); });
      document.getElementById('section-' + tabName).classList.add('active');
    });
  });

  // Initialize Quill for about page
  var aboutEditor = new Quill('#about-editor', {
    theme: 'snow',
    placeholder: 'Rédigez le contenu de la page...',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['blockquote'],
        ['link'],
        ['clean']
      ]
    }
  });

  // Load existing content
  var aboutContentInput = document.getElementById('about-content');
  if (aboutContentInput && aboutContentInput.value) {
    aboutEditor.root.innerHTML = aboutContentInput.value;
  }

  // Form submissions
  document.querySelectorAll('.page-form').forEach(function(form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      var slug = form.dataset.slug;
      var messageEl = document.getElementById(slug + '-message');
      var submitBtn = form.querySelector('button[type="submit"]');

      // If this is the about form, get content from Quill
      if (slug === 'about') {
        aboutContentInput.value = aboutEditor.root.innerHTML;
      }

      messageEl.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enregistrement...';

      var formData = new FormData(form);
      var content = {};
      formData.forEach(function(value, key) {
        content[key] = value.toString();
      });

      try {
        var response = await fetch('/api/pages/' + slug, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content }),
        });

        var result = await response.json();

        if (response.ok) {
          messageEl.textContent = 'Modifications enregistrées !';
          messageEl.className = 'form-message success';
        } else {
          throw new Error(result.error || 'Erreur lors de la sauvegarde');
        }
      } catch (error) {
        messageEl.textContent = error.message || 'Erreur lors de la sauvegarde';
        messageEl.className = 'form-message error';
      } finally {
        messageEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Enregistrer';
      }
    });
  });
</script>
