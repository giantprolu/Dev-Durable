---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Get existing page content or defaults
const homePage = await prisma.pageContent.findUnique({ where: { slug: 'home' } });
const aboutPage = await prisma.pageContent.findUnique({ where: { slug: 'about' } });

const homeContent = (homePage?.content as Record<string, string>) || {
  heroTitle: 'Accompagnons ensemble votre transition vers un modèle durable',
  heroSubtitle: 'AC-ingiénierie vous guide dans votre démarche de développement durable, RSE et transition écologique. Des solutions pragmatiques pour un impact positif et mesurable.',
  ctaText: 'Découvrir nos services',
  secondaryCtaText: 'Nous contacter',
};

const aboutContent = (aboutPage?.content as Record<string, string>) || {
  title: 'À propos',
  subtitle: 'Une conviction simple : le développement durable est un levier de transformation, pas une contrainte.',
  content: '',
};
---

<Layout title="Gestion des pages">
  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Gestion des pages</h1>
        <p>Modifiez le contenu des pages du site</p>
      </div>
      <a href="/admin" class="btn btn--back">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Retour
      </a>
    </header>

    <div class="page-sections">
      <section class="page-section">
        <h2>Page d'accueil</h2>
        <form id="home-form" class="page-form" data-slug="home">
          <div id="home-message" class="form-message" style="display: none;"></div>

          <div class="form-group">
            <label for="home-heroTitle">Titre principal</label>
            <input type="text" id="home-heroTitle" name="heroTitle" value={homeContent.heroTitle} />
          </div>

          <div class="form-group">
            <label for="home-heroSubtitle">Sous-titre</label>
            <textarea id="home-heroSubtitle" name="heroSubtitle" rows="3">{homeContent.heroSubtitle}</textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="home-ctaText">Texte bouton principal</label>
              <input type="text" id="home-ctaText" name="ctaText" value={homeContent.ctaText} />
            </div>
            <div class="form-group">
              <label for="home-secondaryCtaText">Texte bouton secondaire</label>
              <input type="text" id="home-secondaryCtaText" name="secondaryCtaText" value={homeContent.secondaryCtaText} />
            </div>
          </div>

          <button type="submit" class="btn btn--primary">Enregistrer</button>
        </form>
      </section>

      <section class="page-section">
        <h2>Page À propos</h2>
        <form id="about-form" class="page-form" data-slug="about">
          <div id="about-message" class="form-message" style="display: none;"></div>

          <div class="form-group">
            <label for="about-title">Titre</label>
            <input type="text" id="about-title" name="title" value={aboutContent.title} />
          </div>

          <div class="form-group">
            <label for="about-subtitle">Sous-titre</label>
            <input type="text" id="about-subtitle" name="subtitle" value={aboutContent.subtitle} />
          </div>

          <div class="form-group">
            <label for="about-content">Contenu (Markdown)</label>
            <textarea id="about-content" name="content" rows="10">{aboutContent.content}</textarea>
          </div>

          <button type="submit" class="btn btn--primary">Enregistrer</button>
        </form>
      </section>
    </div>
  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-lg);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .page-sections {
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
  }

  .page-section {
    background: var(--color-surface);
    padding: var(--space-6);
    border: var(--border-width) solid var(--color-border-light);
  }

  .page-section h2 {
    font-size: var(--font-size-xl);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border-light);
  }

  .form-row {
    display: grid;
    gap: var(--space-4);
  }

  @media (min-width: 768px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--color-border-light);
    font-size: var(--font-size-base);
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-message {
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
  }

  .form-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>

<script>
  document.querySelectorAll('.page-form').forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formEl = e.target as HTMLFormElement;
      const slug = formEl.dataset.slug;
      const messageEl = document.getElementById(`${slug}-message`) as HTMLElement;
      const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement;

      messageEl.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enregistrement...';

      const formData = new FormData(formEl);
      const content: Record<string, string> = {};
      formData.forEach((value, key) => {
        content[key] = value.toString();
      });

      try {
        const response = await fetch(`/api/pages/${slug}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content }),
        });

        const result = await response.json();

        if (response.ok) {
          messageEl.textContent = 'Modifications enregistrées !';
          messageEl.className = 'form-message success';
        } else {
          throw new Error(result.error || 'Erreur lors de la sauvegarde');
        }
      } catch (error) {
        messageEl.textContent = error instanceof Error ? error.message : 'Erreur lors de la sauvegarde';
        messageEl.className = 'form-message error';
      } finally {
        messageEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enregistrer';
      }
    });
  });
</script>
