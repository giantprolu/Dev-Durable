---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { validateSession, parseSessionCookie } from '../../lib/auth';
import { prisma } from '../../lib/prisma';

// Auth check
const cookieHeader = Astro.request.headers.get('cookie');
const token = parseSessionCookie(cookieHeader);

if (!token) {
  return Astro.redirect('/admin/login');
}

const user = await validateSession(token);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Get existing settings
const settingsArray = await prisma.siteSetting.findMany();
const settings = settingsArray.reduce((acc, s) => {
  acc[s.key] = s.value;
  return acc;
}, {} as Record<string, string>);
---

<Layout title="Paramètres du site">
  <div class="admin-page">
    <header class="admin-page__header">
      <div>
        <h1>Paramètres du site</h1>
        <p>Configurez les informations générales du site</p>
      </div>
      <a href="/admin" class="btn btn--outline">Retour</a>
    </header>

    <form id="settings-form" class="settings-form">
      <div id="form-message" class="form-message" style="display: none;"></div>

      <div class="form-group">
        <label for="siteName">Nom du site</label>
        <input type="text" id="siteName" name="siteName" value={settings.siteName || 'Growing Graham'} />
      </div>

      <div class="form-group">
        <label for="siteDescription">Description du site</label>
        <textarea id="siteDescription" name="siteDescription" rows="3">{settings.siteDescription || ''}</textarea>
        <small>Utilisée pour le SEO et les partages sur les réseaux sociaux</small>
      </div>

      <div class="form-group">
        <label for="contactEmail">Email de contact</label>
        <input type="email" id="contactEmail" name="contactEmail" value={settings.contactEmail || ''} />
      </div>

      <div class="form-group">
        <label for="contactPhone">Téléphone</label>
        <input type="tel" id="contactPhone" name="contactPhone" value={settings.contactPhone || ''} />
      </div>

      <div class="form-group">
        <label for="address">Adresse</label>
        <textarea id="address" name="address" rows="2">{settings.address || ''}</textarea>
      </div>

      <h3>Réseaux sociaux</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="linkedinUrl">LinkedIn</label>
          <input type="url" id="linkedinUrl" name="linkedinUrl" value={settings.linkedinUrl || ''} placeholder="https://linkedin.com/company/..." />
        </div>
        <div class="form-group">
          <label for="twitterUrl">Twitter / X</label>
          <input type="url" id="twitterUrl" name="twitterUrl" value={settings.twitterUrl || ''} placeholder="https://twitter.com/..." />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="facebookUrl">Facebook</label>
          <input type="url" id="facebookUrl" name="facebookUrl" value={settings.facebookUrl || ''} placeholder="https://facebook.com/..." />
        </div>
        <div class="form-group">
          <label for="instagramUrl">Instagram</label>
          <input type="url" id="instagramUrl" name="instagramUrl" value={settings.instagramUrl || ''} placeholder="https://instagram.com/..." />
        </div>
      </div>

      <h3>Apparence</h3>

      <div class="form-group">
        <label for="theme">Thème du site</label>
        <div class="theme-toggle">
          <label class="theme-option">
            <input type="radio" name="theme" value="light" checked={settings.theme !== 'dark'} />
            <span class="theme-option__label">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
              Clair
            </span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="dark" checked={settings.theme === 'dark'} />
            <span class="theme-option__label">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
              Sombre
            </span>
          </label>
        </div>
        <small>Choisissez le thème d'affichage du site</small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn--primary" id="submit-btn">Enregistrer les paramètres</button>
      </div>
    </form>
  </div>
</Layout>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: var(--space-8) var(--section-padding-x);
    max-width: var(--container-lg);
    margin-inline: auto;
  }

  .admin-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: var(--border-width-thick) solid var(--color-primary);
  }

  .admin-page__header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
  }

  .admin-page__header p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .settings-form {
    background: var(--color-surface);
    padding: var(--space-6);
    border: var(--border-width) solid var(--color-border-light);
  }

  .settings-form h3 {
    font-size: var(--font-size-lg);
    margin-top: var(--space-6);
    margin-bottom: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
  }

  .form-row {
    display: grid;
    gap: var(--space-4);
  }

  @media (min-width: 768px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--color-border-light);
    font-size: var(--font-size-base);
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-group small {
    display: block;
    margin-top: var(--space-1);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .form-message {
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
  }

  .form-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .form-actions {
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
  }

  .theme-toggle {
    display: flex;
    gap: var(--space-4);
  }

  .theme-option {
    cursor: pointer;
  }

  .theme-option input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .theme-option__label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border: var(--border-width-thick) solid var(--color-border-light);
    background: var(--color-surface);
    transition: all 0.2s;
  }

  .theme-option input:checked + .theme-option__label {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .theme-option__label:hover {
    border-color: var(--color-primary);
  }

  .theme-option__label svg {
    flex-shrink: 0;
  }
</style>

<script>
  const form = document.getElementById('settings-form') as HTMLFormElement;
  const messageEl = document.getElementById('form-message') as HTMLElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageEl.style.display = 'none';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enregistrement...';

    const formData = new FormData(form);
    const settings: Record<string, string> = {};
    formData.forEach((value, key) => {
      settings[key] = value.toString();
    });

    try {
      const response = await fetch('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings),
      });

      const result = await response.json();

      if (response.ok) {
        messageEl.textContent = 'Paramètres enregistrés !';
        messageEl.className = 'form-message success';
      } else {
        throw new Error(result.error || 'Erreur lors de la sauvegarde');
      }
    } catch (error) {
      messageEl.textContent = error instanceof Error ? error.message : 'Erreur lors de la sauvegarde';
      messageEl.className = 'form-message error';
    } finally {
      messageEl.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enregistrer les paramètres';
    }
  });
</script>
