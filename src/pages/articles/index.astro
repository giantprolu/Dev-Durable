---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Section from '../../components/Section.astro';
import { prisma } from '../../lib/prisma';

// Get articles from database (published only)
const dbArticles = await prisma.article.findMany({
  where: { published: true },
  orderBy: { createdAt: 'desc' },
});

// Normalize articles
type NormalizedArticle = {
  id: string;
  slug: string;
  title: string;
  description: string;
  date: Date;
  tags: string[];
  image: string | null;
  imageAlt: string | null;
};

const articles: NormalizedArticle[] = dbArticles.map((a) => ({
  id: a.id,
  slug: a.slug,
  title: a.title,
  description: a.description,
  date: a.createdAt,
  tags: a.tags,
  image: a.image,
  imageAlt: a.imageAlt,
}));

const allTags = [...new Set(articles.flatMap((article) => article.tags))].sort();

function formatDate(date: Date): string {
  return date.toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<Layout
  title="Articles"
  description="Articles et ressources sur le développement durable, la RSE et la transition écologique."
>
  <div class="page-header">
    <div class="page-header__container">
      <h1 class="page-header__title">Articles</h1>
      <p class="page-header__description">
        Ressources, analyses et retours d'expérience sur le développement durable, la RSE et la transition écologique.
      </p>
    </div>
  </div>

  <Section variant="default">
    <!-- Tags filter -->
    <nav class="tag-list" aria-label="Filtrer par thématique">
      {allTags.map((tag) => (
        <a href="#" class="tag" data-tag={tag}>
          {tag}
        </a>
      ))}
    </nav>

    <!-- Articles grid -->
    <div class="articles-grid">
      {articles.map((article) => (
        <a href={`/articles/${article.slug}`} class="article-card" data-tags={JSON.stringify(article.tags)}>
          {article.image && (
            <div class="article-card__image">
              <img
                src={article.image}
                alt={article.imageAlt || ''}
                loading="lazy"
                width="800"
                height="450"
              />
            </div>
          )}
          <div class="article-card__content">
            <div class="article-card__tags tag-list">
              {article.tags.map((tag: string) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
            <h2 class="article-card__title">{article.title}</h2>
            <p class="article-card__excerpt">{article.description}</p>
            <time class="article-card__meta" datetime={article.date.toISOString()}>
              {formatDate(article.date)}
            </time>
          </div>
        </a>
      ))}
    </div>

  </Section>

  <script>
    const filterTags = document.querySelectorAll<HTMLAnchorElement>('nav.tag-list .tag');
    const articleCards = document.querySelectorAll<HTMLAnchorElement>('.articles-grid .article-card');
    let activeTag: string | null = null;

    filterTags.forEach((tag) => {
      tag.addEventListener('click', (e) => {
        e.preventDefault();
        const selected = tag.dataset.tag;
        if (!selected) return;

        if (activeTag === selected) {
          activeTag = null;
          tag.classList.remove('is-active');
        } else {
          filterTags.forEach((t) => t.classList.remove('is-active'));
          tag.classList.add('is-active');
          activeTag = selected;
        }

        articleCards.forEach((card) => {
          const tags: string[] = JSON.parse(card.dataset.tags!);
          card.style.display = (!activeTag || tags.includes(activeTag)) ? '' : 'none';
        });
      });
    });
  </script>
</Layout>
