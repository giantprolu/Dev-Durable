---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Section from '../../components/Section.astro';
import { getCollection } from 'astro:content';
import { prisma } from '../../lib/prisma';

// Get articles from database (published only)
const dbArticles = await prisma.article.findMany({
  where: { published: true },
  orderBy: { createdAt: 'desc' },
});

// Get articles from file system (for backward compatibility)
const fileArticles = await getCollection('articles');

// Combine and normalize articles
type NormalizedArticle = {
  id: string;
  slug: string;
  title: string;
  description: string;
  date: Date;
  tags: string[];
  image: string | null;
  imageAlt: string | null;
  source: 'db' | 'file';
};

const normalizedDbArticles: NormalizedArticle[] = dbArticles.map((a) => ({
  id: a.id,
  slug: a.slug,
  title: a.title,
  description: a.description,
  date: a.createdAt,
  tags: a.tags,
  image: a.image,
  imageAlt: a.imageAlt,
  source: 'db',
}));

const normalizedFileArticles: NormalizedArticle[] = fileArticles.map((a) => ({
  id: a.id,
  slug: a.id,
  title: a.data.title,
  description: a.data.description,
  date: a.data.date,
  tags: a.data.tags,
  image: a.data.image,
  imageAlt: a.data.imageAlt,
  source: 'file',
}));

// Combine all articles and sort by date
const articles = [...normalizedDbArticles, ...normalizedFileArticles].sort(
  (a, b) => b.date.getTime() - a.date.getTime()
);

const allTags = [...new Set(articles.flatMap((article) => article.tags))].sort();

function formatDate(date: Date): string {
  return date.toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<Layout
  title="Articles"
  description="Articles et ressources sur le développement durable, la RSE et la transition écologique."
>
  <div class="page-header">
    <div class="page-header__container">
      <h1 class="page-header__title">Articles</h1>
      <p class="page-header__description">
        Ressources, analyses et retours d'expérience sur le développement durable, la RSE et la transition écologique.
      </p>
    </div>
  </div>

  <Section variant="default">
    <!-- Tags filter -->
    <nav class="tag-list" aria-label="Filtrer par thématique">
      {allTags.map((tag) => (
        <a href={`/tags/${tag.toLowerCase().replace(/\s+/g, '-').normalize('NFD').replace(/[\u0300-\u036f]/g, '')}`} class="tag">
          {tag}
        </a>
      ))}
    </nav>

    <!-- Articles grid -->
    <div class="articles-grid">
      {articles.map((article) => (
        <a href={`/articles/${article.slug}`} class="article-card">
          {article.image && (
            <div class="article-card__image">
              <img
                src={article.image}
                alt={article.imageAlt || ''}
                loading="lazy"
                width="800"
                height="450"
              />
            </div>
          )}
          <div class="article-card__content">
            <div class="article-card__tags tag-list">
              {article.tags.map((tag: string) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
            <h2 class="article-card__title">{article.title}</h2>
            <p class="article-card__excerpt">{article.description}</p>
            <time class="article-card__meta" datetime={article.date.toISOString()}>
              {formatDate(article.date)}
            </time>
          </div>
        </a>
      ))}
    </div>
  </Section>
</Layout>
