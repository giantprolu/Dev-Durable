---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import Section from '../components/Section.astro';
import ServiceCard from '../components/ServiceCard.astro';
import Button from '../components/Button.astro';
import Card from '../components/Card.astro';
import { prisma } from '../lib/prisma';

// Default icon for services
const defaultIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
  <path d="M2 17l10 5 10-5"/>
  <path d="M2 12l10 5 10-5"/>
</svg>`;

// Get services from database
const dbServices = await prisma.service.findMany({
  where: { published: true },
  orderBy: { order: 'asc' },
  take: 3, // Limit to 3 services for homepage
});

// Get home page content from database
const homePage = await prisma.pageContent.findUnique({
  where: { slug: 'home' },
});

type HomeContent = {
  heroTitle?: string;
  heroSubtitle?: string;
  ctaText?: string;
  secondaryCtaText?: string;
};

const homeContent = (homePage?.content as HomeContent) || {};
const heroTitle = homeContent.heroTitle || 'Accompagnons ensemble votre transition vers un modèle durable';
const heroSubtitle = homeContent.heroSubtitle || 'AC-ingiénierie vous guide dans votre démarche de développement durable, RSE et transition écologique. Des solutions pragmatiques pour un impact positif et mesurable.';
const heroCta = homeContent.ctaText || 'Découvrir nos services';
const heroSecondaryCta = homeContent.secondaryCtaText || 'Nous contacter';

// Default services if none in database
const defaultServices = [
  { title: 'Stratégie RSE', summary: 'Définissez une stratégie de responsabilité sociétale alignée avec vos valeurs.', slug: 'strategie-rse' },
  { title: 'Transition écologique', summary: 'Accompagnement vers une activité plus respectueuse de l\'environnement.', slug: 'transition-ecologique' },
  { title: 'Formation & sensibilisation', summary: 'Formez vos équipes aux enjeux du développement durable.', slug: 'formation' },
];

// Map services for display (use database or defaults)
const servicesToShow = dbServices.length > 0 ? dbServices : defaultServices;
const services = servicesToShow.map((service) => ({
  title: service.title,
  description: service.summary,
  icon: defaultIcon,
  href: `/services/${service.slug}`,
}));

const values = [
  {
    title: 'Expertise',
    description: 'Une connaissance approfondie des enjeux environnementaux et sociétaux contemporains.',
  },
  {
    title: 'Pragmatisme',
    description: 'Des solutions concrètes et adaptées à votre contexte, pas de dogmatisme.',
  },
  {
    title: 'Engagement',
    description: 'Un accompagnement sincère vers une transformation durable et pérenne.',
  },
];
---

<Layout title="Accueil">
  <!-- Hero Section -->
  <Hero
    title={heroTitle}
    subtitle={heroSubtitle}
    ctaText={heroCta}
    ctaHref="/services"
    secondaryCtaText={heroSecondaryCta}
    secondaryCtaHref="/contact"
  />

  <!-- Services Section -->
  <Section id="services" variant="default">
    <header class="section-header">
      <h2>Nos services</h2>
      <p class="lead">
        Un accompagnement sur-mesure pour chaque étape de votre transformation.
      </p>
    </header>

    <div class="services-grid">
      {services.map((service) => (
        <ServiceCard
          title={service.title}
          description={service.description}
          icon={service.icon}
          href={service.href}
        />
      ))}
    </div>
  </Section>

  <!-- About Section -->
  <Section id="a-propos" variant="alt">
    <div class="about-grid">
      <div class="about-content">
        <h2>Pourquoi AC-ingiénierie ?</h2>
        <p class="lead">
          Nous croyons que la transition écologique et sociale est une opportunité de repenser en profondeur votre modèle d'entreprise.
        </p>
        <p>
          Notre approche combine rigueur méthodologique et pragmatisme. Nous ne proposons pas de solutions toutes faites, mais un accompagnement personnalisé qui prend en compte vos contraintes, vos ressources et vos ambitions.
        </p>
        <p>
          L'objectif : des résultats concrets, mesurables et durables dans le temps.
        </p>
        <Button href="/a-propos" variant="outline">
          En savoir plus sur notre approche
        </Button>
      </div>

      <div class="values-list">
        {values.map((value) => (
          <Card variant="default" padding="md">
            <h3 class="value-title">{value.title}</h3>
            <p class="value-description">{value.description}</p>
          </Card>
        ))}
      </div>
    </div>
  </Section>

  <!-- CTA Section -->
  <Section variant="dark" size="lg">
    <div class="cta-content">
      <h2>Prêt à transformer votre entreprise ?</h2>
      <p class="lead">
        Discutons de vos enjeux et de la manière dont nous pouvons vous accompagner.
      </p>
      <div class="cta-actions">
        <Button href="/contact" variant="cta" size="lg">
          Prendre rendez-vous
        </Button>
      </div>
    </div>
  </Section>
</Layout>
